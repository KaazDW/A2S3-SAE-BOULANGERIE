{# templates/facture/nouvelle_facture.html.twig #}

{% extends 'base.html.twig' %}

{% block title %}Nouvelle Facture{% endblock %}

{% block body %}
<div class="container">
                {# AFFICHE LES MESSAGES DE SUCCES  #}
                {% for message in app.flashes('success') %}
                    <div class="alert alert-success">
                        {{ message }}
                    </div>
                {% endfor %}
    <form id="commandeForm" action="/creation_commande" method="post">
        <label for="dateReservation">Date de réservation</label>
        <input type="date" id="dateReservation" name="dateReservation" required>

        <br>
        <h3>à qui la commande est adressée</h3>
        <label for="nom">Nom</label>
        <input type="text" id="nom" name="nom" required>

        <label for="prenom">Prénom</label>
        <input type="text" id="prenom" name="prenom" required>

        <label for="produitDropdown">Sélectionnez un produit :</label>
        <select id="produitDropdown" name="produitDropdown">
            <option value="" disabled selected>Choisissez un produit</option>

            {% for produit in produits %}
                <option value="{{ produit.id }}">{{ produit.nom }} {{produit.prixUnitaire}}€</option>
            {% endfor %}
        </select>

        <div id="produitsSelectionnes"></div>
        <div id="total">Total: €</div>

        <label for="paiementJourMeme">Paiera le jour-même</label>
        <input type="radio" id="paiementJourMeme" name="typePaiement" value="jourMeme" checked>
        <br>
        <label for="paiementDejaEffectue">A déjà payé</label>
        <input type="radio" id="paiementDejaEffectue" name="typePaiement" value="dejaEffectue">
        <br>
        <div id="datePaiementContainer" style="display: none;">
            <label for="datePaiement">Date de paiement</label>
            <input type="datetime-local" id="datePaiement" name="datePaiement">
        </div>

        <button type="submit" onclick="validerFormulaire()">Valider</button>
    </form>
</section>

{# SCRIPT QUI SERT A AFFICHER OU NON LA DATE LORSQUE L'ON CLIQUE SUR A DEJA PAYE #}
<script>
    var paiementJourMeme = document.getElementById("paiementJourMeme");
    var paiementDejaEffectue = document.getElementById("paiementDejaEffectue");
    var datePaiementContainer = document.getElementById("datePaiementContainer");
    var datePaiementInput = document.getElementById("datePaiement");

    paiementJourMeme.addEventListener("change", function () {
        datePaiementContainer.style.display = "none";
        if (datePaiementInput.hasAttribute('required')) {
            datePaiementInput.removeAttribute('required');
        }
    });

    paiementDejaEffectue.addEventListener("change", function () {
        datePaiementContainer.style.display = "block";
        datePaiementInput.setAttribute('required', 'required');
    });
</script>

{# SCRIPT POUR SET LA DATE MINIMALE DE RESERVATION A DEUX JOURS APRES LE JOUR ACTUEL #}
<script>
    var dateReservationInput = document.getElementById("dateReservation");

    var dateActuelle = new Date();

    // Ajout de deux jours à la date actuelle pour obtenir la date minimale de réservation
    dateActuelle.setDate(dateActuelle.getDate() + 2);
    var minDate = dateActuelle.toISOString().split('T')[0]; 

    dateReservationInput.min = minDate;
</script>

<script>

    function validerFormulaire() {
        var nom = document.getElementById("nom").value.trim();
        var prenom = document.getElementById("prenom").value.trim();
        var dateReservation = document.getElementById("dateReservation").value.trim();

        //recupere les infos dans la div des produits sélectionnées
        var produitsSelectionnes = document.querySelectorAll("#produitsSelectionnes div");
        var quantites = document.querySelectorAll("#produitsSelectionnes input[type='number']");

        // Vérification des champs obligatoires
        if (nom === "" || prenom === "" || dateReservation === "" || produitsSelectionnes.length === 0) {
            return;
        }


        //Tableau qui contiendra pour chaque id de produit, une quantité dans la facture
        var produitsEtQuantites = {};

        // parcours l'ensemble des divs crées dans produitsSelectionnes
        for (var i = 0; i < produitsSelectionnes.length; i++) {
            var produitDiv = produitsSelectionnes[i];
            var quantiteDropdown = quantites[i];

            var idProduit = produitDiv.id.replace("produitDiv_", "");
            var quantite = quantiteDropdown.value;

            produitsEtQuantites[idProduit] = quantite;
        }

        var formulaire = document.getElementById("commandeForm");

        document.getElementById("commandeForm").submit();
        
    }

    // GESTIONNAIRE D'EVENEMENT POUR LE DROPDOWN
    document.addEventListener("DOMContentLoaded", function () {
        var produitDropdown = document.getElementById("produitDropdown");
        var produitsSelectionnes = document.getElementById("produitsSelectionnes");

        // Quand un produit du dropdown est sélectionné
        produitDropdown.addEventListener("change", function () {
            var selectedOption = produitDropdown.options[produitDropdown.selectedIndex];

            if (selectedOption.value !== "") {
                // Créér une div pour le produit sélectionné
                var produitDiv = document.createElement("div");
                produitDiv.innerHTML = selectedOption.text;

                // Attribue l'ID du produit comme ID de la div
                produitDiv.id = "produitDiv_" + selectedOption.value;

                // Ajoute le produit à la div des produits sélectionnés
                produitsSelectionnes.appendChild(produitDiv);

                // AJOUTE L'INPUT DE QUANTITE DU PRODUIT
                var quantiteInput = document.createElement("input");
                quantiteInput.type = "number";
                quantiteInput.name = "quantiteProduit[" + selectedOption.value + "]";
                quantiteInput.min = "1"; 
                quantiteInput.value = "1"; // Valeur par défaut

                produitDiv.appendChild(quantiteInput);

                selectedOption.remove();

                // IMAGE POUR SUPPRIMER LE PRODUTI DE LA FACTURE
                var deleteIcon = document.createElement("img");
                deleteIcon.src = "/icons/croix.svg";
                deleteIcon.alt = "supprimer";
                deleteIcon.style.padding = "0 10px";
                deleteIcon.style.marginRight = "10px";
                deleteIcon.style.cursor = "pointer";
                deleteIcon.addEventListener("click", function () {
                    produitDiv.remove(); // Supprime la div du produit sélectionné

                        // LE RAJOUTE AU DROPDOWN
                        var newOption = document.createElement("option");
                        newOption.value = selectedOption.value;
                        newOption.text = selectedOption.text;
                        produitDropdown.appendChild(newOption);
                });
                produitDiv.appendChild(deleteIcon);

                // Retire le produit du dropdown


                // Réinitialise le dropdown pour sélectionner l'option vide
                produitDropdown.selectedIndex = 0;

            }
        });
    });
</script>
{% endblock %}
