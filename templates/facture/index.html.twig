{% extends 'base.html.twig' %}

{% block title %}Liste des Factures{% endblock %}

{% block body %}
    <section class="head">
        <div class="title">
            <h1>Liste des Factures</h1>
        </div>
    </section>
    <section class="facture">
        <div class="first-line">
            <div class="listeFactures" hx-target="this" hx-swap="outerHTML">
                {% include 'facture/factureParDate.html.twig' %}
            </div>
            <div class="case">
                <h2>Récapitulatif des Produits Selectionnés</h2>
                <ul>
                    {% for produitNom, totalProduit in produitTotals %}
                    <li>
                        {{ produitNom }} - Quantité totale: {{ totalProduit }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <div class="second-line">
            <div class="case">
            <h2>Aggrégation des commandes par ingrédients</h2>
            <ul>
                {% for produitNom, totalProduit in produitTotals %}
                    <li>
                        {{ produitNom }} - Quantité totale: {{ totalProduit }}
                        <ul>
                            {% for produit in produits %}
                                {% if produit.nom == produitNom %}
                                    {% for ingredientProduit in produit.ingredients %}
                                        {% set quantiteProduit = totalProduit %}
                                        {% set quantiteUtilisee = ingredientProduit.quantite * quantiteProduit %}
{#                                        {% set stockRestant = ingredientProduit.ingredient.stock - quantiteUtilisee %}#}
                                        <li>{{ ingredientProduit.ingredient.nom }} - Quantité: {{ (ingredientProduit.quantite * quantiteProduit)|number_format(0, '.', ' ') }}g</li>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                            <p>--------------------------</p>
                        </ul>
                    </li>
                {% endfor %}
            </ul>
            </div>
            <div class="case">
            <h2>Gestions des stocks</h2>
            <table>
                <thead>
                <tr>
                    <th>Nom du produit</th>
                    <th>Quantité totale utilisé</th>
                    <th>Stock Avant (kg)</th>
                    <th>Stock Après</th>
                </tr>
                </thead>
                <tbody>
                {% for ingredientNom, quantiteTotale in quantitesTotalesIngredients %}
                    <tr>
                        <td>{{ ingredientNom }}</td>
                        <td>{{ quantiteTotale }}</td>
                        <td>
                            {% for ingredient in ingredients %}
                                {% if ingredient.nom == ingredientNom %}
                                    {{ ingredient.stock }} kg = {{ ingredient.stock * 1000 }} g
                                {% endif %}
                            {% endfor %}
                        </td>

                        <td>
                            {% for ingredient in ingredients %}
                                {% if ingredient.nom == ingredientNom %}
                                    {% if ingredient.nom != "Eau" %}
                                        {% set stockGrammes = ingredient.stock * 1000 - quantiteTotale %}
                                        {% if stockGrammes <= 0 %}
                                            <span style="color: red;">{{ stockGrammes | number_format(0, '.', ' ') }} g</span>
                                        {% else %}
                                            {{ stockGrammes | number_format(0, '.', ' ') }} g
                                        {% endif %}
                                    {% else %}
                                        EAU ILLIMITE
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </td>


                    </tr>
                {% endfor %}
                </tbody>
            </table>

        </div>
        </div>
    </section>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

{% endblock %}